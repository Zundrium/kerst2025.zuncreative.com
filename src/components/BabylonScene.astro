<canvas id="renderCanvas"></canvas>
<script>
import { Engine } from "@babylonjs/core/Engines/engine";
import { Scene } from "@babylonjs/core/scene";
import { UniversalCamera } from "@babylonjs/core/Cameras/universalCamera";
import { ArcRotateCamera } from "@babylonjs/core/Cameras/arcRotateCamera";
import { Vector3 } from "@babylonjs/core/Maths/math.vector";
import { Color4 } from "@babylonjs/core/Maths/math.color";
import { ImportMeshAsync } from "@babylonjs/core/Loading/sceneLoader";
import "@babylonjs/loaders/SPLAT/splatFileLoader";

const canvas = document.getElementById("renderCanvas") as HTMLCanvasElement;
const engine = new Engine(canvas, true, {
		antialias: false,
		powerPreference: "high-performance",
		preserveDrawingBuffer: false,
		stencil: false
});

const optimizeScene = (scene: Scene) => {
	scene.skipPointerMovePicking = true;
	scene.autoClear = false;
	scene.autoClearDepthAndStencil = false;
};

const setupCamera = (scene: Scene, canvas: HTMLCanvasElement) => {
	const camera = new ArcRotateCamera("camera", 
		4.0532, 
		1.0648, 
		60, new Vector3(0, 5, 0), scene);

	camera.minZ = 0.1;
	camera.maxZ = 200;

	camera.attachControl(canvas, true);
	return camera;
};

const loadAssets = async (scene: Scene) => {
	const result = await ImportMeshAsync("/geom/scene.sog", scene);
	const gaussianSplattingMesh = result.meshes[0];

	if (gaussianSplattingMesh) {
		gaussianSplattingMesh.position.y = -2;
		gaussianSplattingMesh.freezeWorldMatrix();
	}
};

const createScene = async () => {
	const scene = new Scene(engine);
	scene.clearColor = new Color4(1, 1, 1, 1);

	optimizeScene(scene);
	setupCamera(scene, canvas);
	await loadAssets(scene);


	return scene;
};

const main = async () => {
	const scene = await createScene();

	engine.runRenderLoop(() => {
		scene.render();
	});
};

const cleanup = () => {
	engine.stopRenderLoop();
	engine.dispose();
};

let resizeTimeout: any;
const handleResize = () => {
	clearTimeout(resizeTimeout);
	resizeTimeout = setTimeout(() => {
		engine.resize();
	}, 100);
};

window.addEventListener("resize", handleResize);
window.addEventListener("beforeunload", cleanup);

main().catch(err => {
	console.error("Failed to initialize scene:", err);
});
</script>

<style>
#renderCanvas {
	width: 100%;
	height: 100%;
	display: block;
	touch-action: none;
	outline: none;
}
</style>
